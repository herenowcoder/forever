#!/bin/bash
#
# (c) 2014 Wojciech Kaczmarek. All rights reserved.
# Released under the BSD 2-clause license - see this for details:
# http://github.com/herenowcoder/forever/blob/master/LICENSE

# see http://superuser.com/a/781762/20912

err() { 
    echo "$1" >&2; exit 1 
}

blue() {
    echo $'\e[34m'${1}$'\e[0m' >&2
}

log() {
    blue "[forever $1 `date +%H:%M:%S`]"
}

stepfile="./forever.step"
[ -x "$stepfile" ] || err "$stepfile should be present"

export TIMEFORMAT='%2U user %2S system %P%% cpu %R total'

case `uname` in
Linux)
    which inotifywait >/dev/null || err "you need 'inotifywait' command (apt-get install inotify-tools  or similar)"
    log started
    while true; do
        time $stepfile $@
        $stepfile files | xargs inotifywait -q -e modify
        [ $? -eq 130 ] && exit 130
        log awakened
    done
    ;;
Darwin)
    which fswatch >/dev/null || err "you need 'fswatch' command (brew install fswatch)"
    log started
    time $stepfile $@
    $stepfile files | xargs fswatch -k -x | while read x; do
        if [ `echo $x | grep -cE Attribute` -eq 0 ]; then
            log awakened
            time $stepfile
        fi
    done
    ;;
FreeBSD)
    err $'FreeBSD not supported. Please donate access to a box with one.\nContact via Github Issues.'
    ;;
esac
